<!DOCTYPE html>
<html>
  <head>
    <title>Abhijeet Kandalkar – Software Engineer @ Igalia | C++ developer | Open Source contributor in Webkit/Chromium</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="Software Engineer @ Igalia | C++ developer | Open Source contributor in Webkit/Chromium">
    <meta property="og:description" content="Software Engineer @ Igalia | C++ developer | Open Source contributor in Webkit/Chromium" />
    
    <meta name="author" content="Abhijeet Kandalkar" />

    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Abhijeet Kandalkar - Software Engineer @ Igalia | C++ developer | Open Source contributor in Webkit/Chromium" href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="/images/me.jpg" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Abhijeet Kandalkar</a></h1>
            <p class="site-description">Software Engineer @ Igalia | C++ developer | Open Source contributor in Webkit/Chromium</p>
          </div>

          <nav>
            <a href="/os">OpenSource</a>
            <a href="/">CV</a>
            <a href="/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <div class="posts">
  
  <!--
    <article class="post">
-->
    <article>
      <a href="/WebXR-on-Windows/">Testing WebXR on Windows</a>
<!--
      <div class="entry">
        <h3 id="webxr-on-windows">WebXR on Windows</h3>

      </div>

      <a href="/WebXR-on-Windows/" class="read-more">Read More</a>
  -->
    </article>
  
  <!--
    <article class="post">
-->
    <article>
      <a href="/Exploring-sandboxing-in-CEF-and-CEFSharp/">Exploring sandboxing in CEF and CEFSharp for Windows platform</a>
<!--
      <div class="entry">
        <p>Sandboxing is a critical feature for ensuring the security and stability of applications that embed web content. In this blog, we will delve into how sandboxing is achieved in the Chromium Embedded Framework (<a href="https://bitbucket.org/chromiumembedded/cef/src/master/">CEF</a>). All analysis in this blog is performed on Windows operating system.</p>

      </div>

      <a href="/Exploring-sandboxing-in-CEF-and-CEFSharp/" class="read-more">Read More</a>
  -->
    </article>
  
  <!--
    <article class="post">
-->
    <article>
      <a href="/improving-disk-read-performance/">Improving disk read performance</a>
<!--
      <div class="entry">
        <p>When I started working on analyzing the startup time of a browser, I didn’t have an idea where to start. For me, Performance was a number game and trial-n-error approach. The challenge I was looking into is described in bug <a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1270977">1270977</a>, in which the chrome binary hosted on two different partitions behaved differently.</p>

      </div>

      <a href="/improving-disk-read-performance/" class="read-more">Read More</a>
  -->
    </article>
  
  <!--
    <article class="post">
-->
    <article>
      <a href="/What-is-LaCrOS/">Introduction to LaCrOS</a>
<!--
      <div class="entry">
        <p>Happy new year to All !!!</p>

      </div>

      <a href="/What-is-LaCrOS/" class="read-more">Read More</a>
  -->
    </article>
  
  <!--
    <article class="post">
-->
    <article>
      <a href="/Up-and-running-WebChimera-with-nwjs-ubuntu/">Up and running WebChimera with nwjs Ubuntu</a>
<!--
      <div class="entry">
        <ul>
  <li>
    <h3 id="add-proxy-to-bashrc">Add proxy to ~/.bashrc</h3>
  </li>
</ul>

      </div>

      <a href="/Up-and-running-WebChimera-with-nwjs-ubuntu/" class="read-more">Read More</a>
  -->
    </article>
  
  <!--
    <article class="post">
-->
    <article>
      <a href="/Up-and-running-WebChimera-with-nwjs-Win/">Up and running WebChimera with nwjs</a>
<!--
      <div class="entry">
        <ul>
  <li>
    <h3 id="add-proxy-to-windows-environment">Add proxy to windows environment</h3>
  </li>
</ul>

      </div>

      <a href="/Up-and-running-WebChimera-with-nwjs-Win/" class="read-more">Read More</a>
  -->
    </article>
  
  <!--
    <article class="post">
-->
    <article>
      <a href="/Up-and-running-webassembly/">Up and running webassembly in browser</a>
<!--
      <div class="entry">
        <h2 id="asm-to-webassembly">ASM to WebAssembly</h2>

      </div>

      <a href="/Up-and-running-webassembly/" class="read-more">Read More</a>
  -->
    </article>
  
  <!--
    <article class="post">
-->
    <article>
      <a href="/Up-and-running-ASMjs/">Up and running ASM.js in browser</a>
<!--
      <div class="entry">
        <ul>
  <li>
    <h3 id="install-emscripten-sdk">Install Emscripten SDK</h3>
    <p>Download Emscripten SDK Offline Installer and install it. For more information about installation process refer <a href="https://kripken.github.io/emscripten-site/docs/getting_started/index.html">https://kripken.github.io/emscripten-site/docs/getting_started/index.html</a></p>
  </li>
</ul>

      </div>

      <a href="/Up-and-running-ASMjs/" class="read-more">Read More</a>
  -->
    </article>
  
  <!--
    <article class="post">
-->
    <article>
      <a href="/Building-ffmpeg-form-nwjs-or-chromium-repository/">Building ffmpeg form nwjs/chromium repository</a>
<!--
      <div class="entry">
        <ul>
  <li>
    <p>Open VS2013 x64 Native Tools Command Prompt
C:\Program Files (x86)\Microsoft Visual Studio 12.0\Common7\Tools\Shortcuts</p>
  </li>
  <li>
    <p>Open C:\cygwin64\Cygwin.bat in VS2013 x64 Native Tools Command Prompt and make sure that compiler and linker are refering to VS2013 64 bit executables as shown below.[Assuming you have cygwin installed on your Windows machine]</p>
  </li>
</ul>

<p><img src="/images/Building-ffmpeg-form-nwjs-or-chromium-repository/image001.png" alt="alt text" title="Building ffmpeg form nwjs/chromium repository" /></p>

<ul>
  <li>Set following environment variables</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nb">set </span><span class="nv">GYP_DEFINES</span><span class="o">=</span><span class="nv">host_arch</span><span class="o">=</span>x64 <span class="nv">target_arch</span><span class="o">=</span>x64 <span class="nv">nwjs_sdk</span><span class="o">=</span>1 <span class="nv">disable_nacl</span><span class="o">=</span>0 <span class="nv">proprietary_codecs</span><span class="o">=</span>1 <span class="nv">branding</span><span class="o">=</span>Chrome
</code></pre></div></div>

<p><img src="/images/Building-ffmpeg-form-nwjs-or-chromium-repository/image002.png" alt="alt text" title="Building ffmpeg form nwjs/chromium repository" /></p>

<ul>
  <li>Go to Ffmpeg source code location :</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    &lt;node-webkit-dir&gt;<span class="se">\s</span>rc<span class="se">\t</span>hird_party<span class="se">\f</span>fmpeg
</code></pre></div></div>

<ul>
  <li><strong>[APPLY PATCH to file ]</strong> <ffmpeg_src>/chromium/scripts/build_ffmpeg.py</ffmpeg_src></li>
</ul>

<p>Add support of mxf by enabling it as decoder, demuxer and parser</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gd">-      '--enable-decoder=pcm_s16be,pcm_s24be,pcm_mulaw,pcm_alaw',
-      '--enable-demuxer=ogg,matroska,wav',
-      '--enable-parser=opus,vp3,vorbis,vp8',
</span><span class="err">
</span><span class="gi">+      '--enable-decoder=pcm_s16be,pcm_s24be,pcm_mulaw,pcm_alaw,mxf',
+      '--enable-demuxer=ogg,matroska,wav,mxf',
+      '--enable-parser=opus,vp3,vorbis,vp8,mxf',
</span></code></pre></div></div>

<ul>
  <li><strong>[APPLY PATCH to file ]</strong> : <ffmpeg_src>/chromium/scripts/build_ffmpeg.py</ffmpeg_src></li>
</ul>

<p>Add support of mxf by enabling it as decoder, demuxer and parser</p>

<div class="language-diff highlighter-rouge"><div class="highlight"><pre class="highlight"><code>       ['chromeos == 1', {
         'ffmpeg_branding%': '&lt;(branding)OS',
       }, {  # otherwise, assume Chrome/Chromium.
<span class="gd">-        'ffmpeg_branding%': '&lt;(branding)',
</span><span class="gi">+         'ffmpeg_branding%': 'Chrome',
</span>       }],
     ],
</code></pre></div></div>

<ul>
  <li>Build standalone ffmpeg code for windows 64 bit.</li>
</ul>

<p><img src="/images/Building-ffmpeg-form-nwjs-or-chromium-repository/image003.png" alt="alt text" title="Building ffmpeg form nwjs/chromium repository" /></p>

<ul>
  <li>
    <p>Build will generate following directory <strong>build.x64.win</strong><ffmpeg_src> folder.</ffmpeg_src></p>
  </li>
  <li>
    <p>Copy config and from <strong>build.x64.win</strong>:</p>
  </li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ffmpeg_src&gt;./chromium/scripts/copy_config.sh
</code></pre></div></div>

<p>Regenerate ffmpeg gyp files :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ffmpeg_src&gt;python chromium/scripts/generate_gyp.py
</code></pre></div></div>

<p><img src="/images/Building-ffmpeg-form-nwjs-or-chromium-repository/image004.png" alt="alt text" title="Building ffmpeg form nwjs/chromium repository" /></p>

<p>Following files get modified after running above commands:</p>

<p><img src="/images/Building-ffmpeg-form-nwjs-or-chromium-repository/image005.png" alt="alt text" title="Building ffmpeg form nwjs/chromium repository" /></p>

<ul>
  <li><strong>Force nwjs(chromium) to regenerate ninja files</strong> for modified  *.h, *.asm, *.gypi (see previous step): 
Go to nwjs source code location :  /node-webkit/src</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>src&gt;gclientrunhook–force
</code></pre></div></div>

<p><img src="/images/Building-ffmpeg-form-nwjs-or-chromium-repository/image006.png" alt="alt text" title="Building ffmpeg form nwjs/chromium repository" /></p>

<ul>
  <li>Build ffmpeg code using ninja to generate ffmpegsumo.dll:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>src&gt;ninja <span class="nt">-C</span> out/Debug_x64 ffmpegsumo-j16
</code></pre></div></div>

<p><img src="/images/Building-ffmpeg-form-nwjs-or-chromium-repository/image007.png" alt="alt text" title="Building ffmpeg form nwjs/chromium repository" /></p>

<ul>
  <li>Build nwjs code using ninja and link to ffmpegsumo.dll:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>src&gt;ninja <span class="nt">-C</span> out/Debug_x64 nw <span class="nt">-j16</span>
</code></pre></div></div>

<p><img src="/images/Building-ffmpeg-form-nwjs-or-chromium-repository/image008.png" alt="alt text" title="Building ffmpeg form nwjs/chromium repository" /></p>

      </div>

      <a href="/Building-ffmpeg-form-nwjs-or-chromium-repository/" class="read-more">Read More</a>
  -->
    </article>
  
  <!--
    <article class="post">
-->
    <article>
      <a href="/Building-nwjs-on-Windows7-64-bit/">Building nwjs on Windows7 64 bit</a>
<!--
      <div class="entry">
        <p>##Install depot_tools : ##</p>
<ul>
  <li>Download code</li>
</ul>

      </div>

      <a href="/Building-nwjs-on-Windows7-64-bit/" class="read-more">Read More</a>
  -->
    </article>
  
  <!--
    <article class="post">
-->
    <article>
      <a href="/Building-ffmpeg-and-ffplay-on-Windows7-64-bit/">Building ffmpeg and ffplay on Windows7 64 bit</a>
<!--
      <div class="entry">
        <p>##Prerequisite for ffmpeg##</p>
<ul>
  <li>Install Msys64 on yourmachine. (msys2-x86_64-20150916.exe)</li>
</ul>

      </div>

      <a href="/Building-ffmpeg-and-ffplay-on-Windows7-64-bit/" class="read-more">Read More</a>
  -->
    </article>
  
  <!--
    <article class="post">
-->
    <article>
      <a href="/Video-rendering-in-chromium-nwjs/">Video element rendering in chromium nwjs</a>
<!--
      <div class="entry">
        <h2 id="video-rendering-in-chromiumnwjs">Video rendering in chromium/nwjs:</h2>

<p>There are three major components to Chromium’s video implementation:</p>

<ul>
  <li><strong>Pipeline</strong>
    <ul>
      <li>Chromium’s implementation of a media playback engine</li>
      <li>Handles asynchronous operations like audio/video demuxing decoding, synchronization and resource fetching</li>
      <li>Pipeline works like a state machine to perform asynchronous initialization, pausing, seeking and playing.</li>
    </ul>
  </li>
  <li><strong>FFmpeg</strong>
    <ul>
      <li>Open source library used for Demuxing(container format parsing) and audio/video decoding</li>
      <li>implements parallel frame-level decoding for many popular codecs.</li>
    </ul>
  </li>
  <li><strong>WebKit</strong>
    <ul>
      <li>Implements the HTML and Javascript bindings ( to communicate with video element using javascript)</li>
      <li>Handles rendering the user agent controls (Creation of media player UI)</li>
      <li>Provides WebMediaPlayer interface for port-specific implementations of a media playback engine</li>
    </ul>
  </li>
</ul>

<p>###Pipeline:###</p>

<p>The pipeline is a pull-based media playback engine that abstracts each step of media playback into 6 different filters.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1. data source
2. demuxing 
3. audio decoding
4. video decoding 
5. audio rendering
6. video rendering 
</code></pre></div></div>

<p>The pipeline manages the lifetime of the filters and exposes a simple thread-safe interface to clients.  The filters are connected together to form a filter graph. All 6 filters are running in different thread to provide responsive media playback in browser. Caching of data is implemented at each filter level.
Pipeline is completely pull-based and relies on the system clock (vsync) to drive playback.  As the system clock requests additional data, the video renderer requests decoded video data from the video decoder, which requests encoded buffers from the demuxer, which reads from the data source, and so on.</p>

<p><strong><em>State machine of pipeline:</em></strong></p>

<p><img src="/images/Video-rendering-in-chromium-nwjs/state_machine.png" alt="alt text" title="Video element rendering in chromium nwjs" /></p>

<p><strong>Working of filters in pipeline</strong></p>

<p><img src="/images/Video-rendering-in-chromium-nwjs/image002.png" alt="alt text" title="Video element rendering in chromium nwjs" /></p>

<p><strong>Caching of data is implemented at each filter level.</strong></p>

<p><img src="/images/Video-rendering-in-chromium-nwjs/image004.png" alt="alt text" title="Video element rendering in chromium nwjs" /></p>

<p><strong>Pipeline and ffmpeg</strong></p>

<p><img src="/images/Video-rendering-in-chromium-nwjs/image005.png" alt="alt text" title="Video element rendering in chromium nwjs" /></p>

<hr />

<p><strong>Following are filters names and their respective implementation in chromium code.</strong></p>

<ul>
  <li>Data source	<strong>BufferedDataSource</strong>
    <ul>
      <li>A data source capable of loading URLs and buffering the data using an in-memory sliding window.</li>
      <li>This class ask network layer to fetch data.</li>
      <li>BufferedDataSource::intermediate_read_buffer_ variable stores data downloaded from network.</li>
    </ul>
  </li>
  <li>Demuxing	<strong>FFmpegDemuxer/FFmpegDemuxerStream/DemuxerStream</strong>
    <ul>
      <li>Demuxer initialises ffmpeg using FFmpegGlue class.</li>
      <li>Demuxer use buffers downloaded by data source and     attempt to recognize the container by looking at the first few bytes</li>
      <li>Demuxer determines number of streams , type of streams(audio/video) and check whether
 video/audio codec configuration supported</li>
      <li>Create audio/video ffmegDemuxerStream and put ffmpeg::AVStream in it.</li>
      <li>DemuxerStream and a list of Decoders and provides decoded output to Audio/VideoRendererImpl</li>
    </ul>
  </li>
  <li>Audio Decoder	<strong>FFmpegAudioDecoder</strong>
    <ul>
      <li>FFmpegAudioDecoder is wrapper over audio actual decoders provided by ffmpeg.</li>
      <li>On the basis of audio codec information we determine using demuxer, FFmpegAudioDecoder initialise respective ffmpeg decoder.</li>
      <li>FFmpegAudioDecoder ask ffmpeg to decode frames present inside encoded ffmpegDemuxerStreams::AudioStreams.</li>
      <li>Decoded frames generated by FFmpegAudioDecoder are consumed by AudioRendererImpl.</li>
    </ul>
  </li>
  <li>Video Decoder	<strong>FFmpegVideoDecoder</strong>
    <ul>
      <li>FFmpegVideoDecoder is wrapper over actual video decoders provided by ffmpeg.</li>
      <li>On the basis of video codec information we determine using demuxer, FFmpegVideoDecoder initialise respective ffmpeg decoder.</li>
      <li>FFmpegVideoDecoder ask ffmpeg to decode frames present inside encoded ffmpegDemuxerStreams::VideoStreams.</li>
      <li>FFmpegVideoDecoder allocates memory for decoded data.(CPU and GPU based on SW/HW decoder)</li>
      <li>Decoded frames(videoFrame) generated by FFmpegVideoDecoder are consumed by VideoRendererImpl.</li>
    </ul>
  </li>
  <li>Audio Rendering	<strong>AudioRendererImpl</strong>
    <ul>
      <li>It is responsible for initialization of audio decoder.</li>
      <li>AudioRendererImpl talks to an AudioRendererAlgorithm that takes care of queueing audio data and stretching/shrinking audio data.</li>
      <li>It will provide decode audio frames to sound card.
  Video Rendering	VideoRendererImpl</li>
      <li>It is responsible for initialization of video decoder.</li>
      <li>VideoRendererImpl creates its own thread for the sole purpose of timing frame presentation.</li>
      <li>It handles reading from the VideoFrameStream and stores the results in a queue of decoded frames and executing a callback to notify compositing/painting when a frame is ready for rendering.</li>
      <li>ready_outputs_ : variable stores decoded data</li>
    </ul>
  </li>
</ul>

<hr />

<p><strong>Other important classes:</strong></p>

<ul>
  <li><strong>WebMediaPlayerImpl</strong>
    <ul>
      <li>Runs in three thread:
        <ul>
          <li>Media Thread</li>
          <li>Renderer Thread</li>
          <li>Compositor thread.</li>
        </ul>
      </li>
      <li>The canonical implementation of blink::WebMediaPlayer that’s backed by Pipeline.</li>
      <li>Handles normal resource loading, Media Source, and Encrypted Media.</li>
    </ul>
  </li>
  <li><strong>FFmpegURLProtocol</strong>
  It maintain state of your seek and read position while interacting with network using bufferDataSource.</li>
  <li><strong>DecoderBufferQueue</strong>
  Maintains a queue of DecoderBuffers in increasing timestamp order.</li>
</ul>

<hr />

<p><strong>Chromium-ffmpeg implementation known facts:</strong></p>

<ul>
  <li>Wrappers written by chromium to make playback responsive are tightly couple with ffmpeg. (They are written considering ffmpeg as underlying media framework and they are not generic)</li>
  <li>FFmpeg works on buffers provided by networks(bufferDataSource)</li>
  <li>FFmpeg can be decomposed to run in threaded implementation for demuxing, decoding and rendering.</li>
  <li>Caching of data is implemented at each filter level.</li>
  <li>HTML Media Elements like audio, video and Web audio are depends on chromium-ffmpeg integration. This Media elements uses underlying playback engine (pipeline) and media framework (Ffmpeg).</li>
  <li>Ffmpeg supports almost all pixel format but Chromium pipeline supports only famous pixel formats.</li>
</ul>

<hr />

<p><strong>References:</strong>
	- https://www.chromium.org/developers/design-documents/video</p>


      </div>

      <a href="/Video-rendering-in-chromium-nwjs/" class="read-more">Read More</a>
  -->
    </article>
  
  <!--
    <article class="post">
-->
    <article>
      <a href="/Video-rendering-in-chromium(Sequence-diagram)/">Life cycle of Video element in chromium(m41)</a>
<!--
      <div class="entry">
        <h2 id="life-cycle-of-video-element">Life cycle of Video element:</h2>

<p><img src="/images/video_rendering_sequence_diagram/image00001.jpeg" alt="Sequence diagram for Life cycle of Video element in chromium(m41)" title="Life cycle of Video element in chromium(m41)" /></p>


      </div>

      <a href="/Video-rendering-in-chromium(Sequence-diagram)/" class="read-more">Read More</a>
  -->
    </article>
  
</div>
    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          



<a href="https://github.com/abhijeetk"><i class="svg-icon github"></i></a>

<a href="https://www.linkedin.com/in/abhijeetkandalkar"><i class="svg-icon linkedin"></i></a>


<a href="https://www.twitter.com/Abhijeet58"><i class="svg-icon twitter"></i></a>



        </footer>
      </div>
    </div>

    

  </body>
</html>
